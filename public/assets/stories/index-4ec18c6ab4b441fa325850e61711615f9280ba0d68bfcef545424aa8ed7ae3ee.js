function storiesIndex(){initGridPreviews({},function(){gon.preview_story&&($('li[data-story-id="'+gon.preview_story.toString()+'"] > a')[0].click(),delete gon.preview_story)})}function storiesIndexListeners(){var e=function(e){e.addClass("loading"),setTimeout(function(){e.addClass("still-loading")},1e3),$("#stories-gallery li").css("pointer-events","none")},t=function(){$(".select2-selection__rendered li:not(:last-of-type)").each(function(e,t){tagId=$("#grouped-stories-filter").select2("data")[e].id,tagText=$("#grouped-stories-filter").select2("data")[e].text,t.innerHTML.includes("Category:")||t.innerHTML.includes("Product:")||(t.innerHTML=t.innerHTML.replace(tagText,tagId.includes("c")?"Category:\xa0"+tagText:"Product:\xa0"+tagText))})},s=function(e,s){var r=[];e&&r.push("c"+e),s&&r.push("p"+s),$('[name="category_select"]').val(e).trigger("change.select2"),$('[name="product_select"]').val(s).trigger("change.select2"),$('[name="filter_select[]"]').val(r).trigger("change.select2"),t()};$(document).on("input",".stories-search",function(){$(".stories-search").not($(this)).val($(this).val()),$('.stories-search-form [name="search"]').val($(this).val()),$(".clear-search").hide(),$(".stories-search-form .input-group-btn").removeClass("show-clear")}).on("click",".submit-search",function(){return""!==$(this).closest("form").find(".stories-search").val()&&void $(this).closest("form").submit()}).on("click",".clear-search",function(){$(".stories-search").val("").trigger("input"),$(".search-results").text(""),updateGallery($(_.template($("#stories-template").html())({stories:filterStories("",""),isCurator:!1})))}).on("submit",".stories-search-form",function(){$(".search-results").text(""),replaceStateStoriesIndex("",""),$(".stories-search-form .input-group-btn").addClass("show-clear")}).on("click","a.published",function(){var t=$(this).closest("li");e(t)}).on("change","#grouped-stories-filter",function(){var e=$(this).val()&&$(this).val().find(function(e){return e.includes("c")}),t=e&&e.slice(1,e.length),r=t&&$(this).find('optgroup[label="Category"] option:selected').data("slug"),i=$(this).val()&&$(this).val().find(function(e){return e.includes("p")}),l=i&&i.slice(1,i.length),n=l&&$(this).find('optgroup[label="Product"] option:selected').data("slug"),o=filterStories(t,l),a=1===o.length?"1 story found":o.length.toString()+" stories found",c=1===filterStories(t,"").length?"1 story found":filterStories(t,"").length.toString()+" stories found",u=1===filterStories("",l).length?"1 story found":filterStories("",l).length.toString()+" stories found";s(t,l),$(".stories-search").val("").trigger("input"),$(".search-results").text(""),t||l?($(".filters-container.visible-xs-block .filter-results > span").text(a),$(".filters-container.tall .combined-results").find("> span > span:last-child").text(a).end().find("> span").show(),t?$(".stories-filter.category-select").nextAll(".filter-results").children("span").text(c):$(".stories-filter.category-select").nextAll(".filter-results").children("span").text(""),l?$(".stories-filter.product-select").nextAll(".filter-results").children("span").text(u):$(".stories-filter.product-select").nextAll(".filter-results").children("span").text("")):($(".filters-container.visible-xs-block .filter-results > span").text(""),$(".filters-container.tall .combined-results > span").hide()),updateGallery($(_.template($("#stories-template").html())({stories:o,isCurator:!1}))),replaceStateStoriesIndex(r,n)}).on("change",".stories-filter",function(){var e=$(this).closest(".filters-container").find("[name='category_select']"),t=e.val(),r=t&&e.find("option:selected").data("slug"),i=$(this).closest(".filters-container").find("[name='product_select']"),l=i.val(),n=l&&i.find("option:selected").data("slug"),o=filterStories(t,l),a=1===o.length?"1 story found":o.length.toString()+" stories found",c=1===filterStories(t,"").length?"1 story found":filterStories(t,"").length.toString()+" stories found",u=1===filterStories("",l).length?"1 story found":filterStories("",l).length.toString()+" stories found";s(t,l),$(".stories-search").val("").trigger("input"),$(".search-results").hide(),t||l?($(".filters-container.tall .combined-results").find("> span > span:last-child").text(a).end().find("> span").show(),$(".filters-container.visible-xs-block .filter-results > span").text(a)):($(".filters-container.tall .combined-results > span").hide(),$(".filters-container.visible-xs-block .filter-results > span").text("")),$(".stories-filter").each(function(){$(this).val()?$(this).closest(".form-group").find(".filter-results > span").text($(this).hasClass("category-select")?c:u):$(this).closest(".form-group").find(".filter-results > span").text("")}),$("#grouped-stories-filter").val()?$("#filters-container.visible-xs-block .filter-results > span").text(a):$("#filters-container.visible-xs-block .filter-results > span").text(""),updateGallery($(_.template($("#stories-template").html())({stories:o,isCurator:!1}))),replaceStateStoriesIndex(r,n)})}function filterStories(e,t){var s=CSP.stories.filter(function(e){return e.logo_published||e.preview_published}),r=e?_.pluck(s.filter(function(t){return t.success.story_categories&&t.success.story_categories.some(function(t){return t.id==e})}),"id"):_.pluck(s,"id"),i=t?_.pluck(s.filter(function(e){return e.success.products&&e.success.products.some(function(e){return e.id==t})}),"id"):_.pluck(s,"id"),l=_.intersection(r,i);return s.filter(function(e){return l.includes(e.id)})}function preSelectFilters(){}function updateGallery(e){$("#stories-gallery").imagesLoaded(function(){$("#stories-gallery").empty().append(e).hide().show("fast",initGridPreviews)})}function replaceStateStoriesIndex(e,t){e||t?e&&!t?history.replaceState({turbolinks:!0},null,"/?category="+e):!e&&t?history.replaceState({turbolinks:!0},null,"/?product="+t):e&&t&&history.replaceState({turbolinks:!0},null,"/?category="+e+"&product="+t):history.replaceState({turbolinks:!0},null,"/")}