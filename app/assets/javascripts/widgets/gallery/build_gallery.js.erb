
function cspBuildGalleryWidget ($container, cspRootUrl) {

  var Modernizr,
      $story,
      loading = function ($storyCard) {
        $storyCard.addClass('cs-loading');
        $('#cs-gallery a').css('pointer-events', 'none');
        setTimeout(function () {
          if (!$storyCard.hasClass('cs-loaded')) {
            $storyCard.addClass('cs-still-loading');
          }
        }, 1000);
      };

  /**
   * asset_url works as expected in cs.js.erb (which is served as a view),
   * but in this file (served outside asset pipeline), asset_url returns only the path.
   * solution: pass in root_url from cs.js.erb
   */
  $.getScript(cspRootUrl + "<%= asset_path('widgets/gallery/story_overlays') %>");

  $container
    .on('click', 'a.published', function (e) {
      e.preventDefault();
      var $storyCard = $(this);
      if ($storyCard.hasClass('cs-loaded')) {
        setTimeout(function () {
          $storyCard.removeClass('cs-loading cs-still-loading');
        }, 300);  // matches overlay animation time
        return false;
      } else {
        loading($storyCard);
        $.ajax({
          url: $storyCard.attr('href'),
          method: 'GET',
          data: {
            is_widget: true
          },
          dataType: 'jsonp'
        })
          .done(function (data, status, jqxhr) {
            $.when(
              $container
                .find('.content__item:nth-of-type(' + ($storyCard.index() + 1) + ')')
                .html(data.html)
            )
              .done(function () {
                $storyCard.addClass('cs-loaded');
                if (typeof cspInitVideo !== 'function') {
                  $.getScript(cspRootUrl + "<%= asset_path('widgets/gallery/story_video') %>", function () {
                    cspInitVideo($storyCard);
                  });
                } else {
                  cspInitVideo($storyCard);
                }

                // when loading, all cards were set to pointer-events: none
                // now undo that...
                $container.find('a').removeAttr('style');

                // the grid_overlays.js listener is vanilla js,
                // won't pick up on $storyCard.trigger('click')
                $storyCard[0].click();


              });
          })
          .fail(function () {

          });
      }
    });
}

