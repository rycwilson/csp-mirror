
function cspBuildGalleryWidget ($container, cspRootUrl) {

  var Modernizr,
      loading = function ($story) {
        $story.addClass('cs-loading');
        $('#cs-gallery a').css('pointer-events', 'none');
        setTimeout(function () {
          if (!$story.hasClass('cs-loaded')) {
            $story.addClass('cs-still-loading');
          }
        }, 1000);
      };

  /**
   * asset_url works as expected in cs.js.erb (which is served as a view),
   * but in this file (served outside asset pipeline), asset_url returns only the path.
   * solution: pass in root_url from cs.js.erb
   */
  $.getScript(cspRootUrl + "<%= asset_path('widgets/gallery/story_overlays') %>");

  $container
    .on('click', 'a.published', function (e) {
      e.preventDefault();
      var $story = $(this);
      if ($story.hasClass('cs-loaded')) {
        setTimeout(function () {
          $story.removeClass('cs-loading cs-still-loading');
        }, 300);  // matches overlay animation time
        return false;
      } else {
        loading($story);
        $.ajax({
          url: $story.attr('href'),
          method: 'GET',
          data: {
            is_widget: true
          },
          dataType: 'jsonp'
        })
          .done(function (data, status, jqxhr) {
            $.when(
              $container.find('.content__item:nth-of-type(' + ($story.index() + 1).toString() + ')')
                .html(data.html)
            )
              .done(function () {
                $story.addClass('cs-loaded');
                $.getScript(cspRootUrl + "<%= asset_path('widgets/gallery/story_video') %>", function () {

                  // when loading, all cards were set to pointer-events: none
                  // now undo that...
                  $container.find('a').removeAttr('style');

                  // the grid_overlays.js listener is vanilla js,
                  // won't pick up on $story.trigger('click')
                  $story[0].click();
                });
              });
          })
          .fail(function () {

          });
      }
    });
}

