
function cspBuildGallery ($container, cspRootUrl) {

  var Modernizr, $story,
      loading = function ($storyCard) {
        $storyCard.addClass('cs-loading');
        $('#cs-gallery a').css('pointer-events', 'none');
        setTimeout(function () {
          if (!$storyCard.hasClass('cs-loaded')) {
            $storyCard.addClass('cs-still-loading');
          }
        }, 1000);
      },
      initVideo = function ($story) {
        if (typeof cspInitVideo !== 'function') {
          $.getScript(cspRootUrl + "<%= asset_path('widgets/gallery/story_video') %>", function () {
            cspInitVideo($story);
          });
        } else {
          cspInitVideo($story);
        }
      };

  /**
   * asset_url works as expected in cs.js.erb (which is served as a view),
   * but in this file (served outside asset pipeline), asset_url returns only the path.
   * solution: pass in root_url from cs.js.erb
   */
  $.getScript(cspRootUrl + "<%= asset_path('widgets/gallery/story_overlays') %>");

  $container
    .on('click', 'a.published, a.preview-published', function (e) {
      e.preventDefault();
      var $storyCard = $(this);
      if ($storyCard.hasClass('cs-loaded')) {
        setTimeout(function () {
          $storyCard.removeClass('cs-loading cs-still-loading');
        }, 300);  // matches overlay animation time
        return false;
      } else {
        loading($storyCard);
        $.ajax({
          url: $storyCard.attr('href'),
          method: 'GET',
          data: {
            is_widget: true,
            window_width: $(window).width()
          },
          dataType: 'jsonp'
        })
          .done(function (data, status, jqxhr) {
            $story = $container.find('.content__item:nth-of-type(' + ($storyCard.index() + 1) + ')');
            $.when(
              $story.html(data.html),
              $storyCard.addClass('cs-loaded')
            )
              .then(function () { widgetsListener($story); })
              .then(function () {
                if ($storyCard.hasClass('published has-video')) {
                  initVideo($story);
                }
                initLinkedIn();

                // when loading, all cards were set to pointer-events: none
                // now undo that...
                $container.find('a').removeAttr('style');

                $container.on('click touchend', '.close-button-xs', function () {
                  $(this).closest('.cs-content').find('.close-button').trigger('click');
                });

                // the grid_overlays.js listener is vanilla js,
                // won't pick up on $storyCard.trigger('click')
                $storyCard[0].click();

              });
          })
          .fail(function () {

          });
      }
    })
    .find('.cs-grid').removeClass('hidden');

}

