
(function () {

  var resData = <%= raw @response_data.to_json %>,
      story = <%= raw @story.to_json({
                    only: [:id, :title, :logo_published, :preview_published, :published],
                    methods: [:previous_changes, :csp_story_path],
                    include: {
                      success: {
                        only: [],
                        include: {
                          customer: { only: [:name] }
                        }
                      }
                    }
                  }) %>,
      $hiddenAdInputs = $('#story-settings__ads-inputs'),

      // update any story attributes that fall under Settings
      updateStory = function () {
        var storyIndex = CSP.stories.findIndex(function (st) { return st.id === story.id });
        CSP.stories[storyIndex].csp_story_path = story.csp_story_path;
        CSP.stories[storyIndex].logo_published = story.logo_published;
        CSP.stories[storyIndex].preview_published = story.preview_published;
        CSP.stories[storyIndex].published = story.published;
        CSP.stories[storyIndex].title = story.title;
        $('#story-header__title > span:nth-of-type(2)').text(story.title);
      },
      flash = function () {
        var $flash = $('#story-header__flash'),
            logoWasPublished = resData.previousChanges.logo_published &&
                               resData.previousChanges.logo_published[1] &&
                               'Logo published',
            logoWasUnpublished = resData.previousChanges.logo_published &&
                                 resData.previousChanges.logo_published[0] &&
                                 'Logo unpublished',
            previewWasPublished = resData.previousChanges.preview_published &&
                                  resData.previousChanges.preview_published[1] &&
                                  'Preview published',
            previewWasUnpublished = resData.previousChanges.preview_published &&
                                    resData.previousChanges.preview_published[0] &&
                                    'Preview unpublished',
            storyWasPublished = resData.previousChanges.published &&
                                resData.previousChanges.published[1] &&
                                'Story published',
            storyWasUnpublished = resData.previousChanges.published &&
                                  resData.previousChanges.published[0] &&
                                  'Story unpublished',
            flashIsPresent = logoWasPublished || logoWasUnpublished ||
                             previewWasPublished || previewWasUnpublished ||
                             storyWasPublished || storyWasUnpublished;

        /**
         *  in the event there are two changes (e.g. logo published and story published),
         *  limit flash to publish state / google ads
         */
        if (storyWasPublished || storyWasUnpublished) {
          $('#story-header__flash')
            .addClass('alert ' + (resData.gadsErrors ? 'alert-warning' : 'alert-success'))
            .html(
              '<ul class="fa-ul" style="margin: 0">' +
                '<li>' +
                  '<strong><i class="fa fa-fw fa-check"></i></strong>&nbsp;&nbsp;' +
                  '<p style="display: inline-block">' + (storyWasPublished || storyWasUnpublished) + ' successfully' + '</p>' +
                '</li>' +
                '<li>' +
                  '<strong><i class="fa fa-fw ' + (resData.gadsErrors ? 'fa-warning' : 'fa-check') + '"></i></strong>&nbsp;&nbsp;' +
                  '<p style="display: inline-block; margin-bottom: 0">' +
                    (resData.gadsErrors ?
                      'Errors when ' + (storyWasPublished ? 'creating' : 'removing') + ' Promoted Story' :
                      'Promoted Story ' + (storyWasPublished ? 'created' : 'removed') + ' successfully') +
                  '</p>' +
                '</li>' +
              '</ul>'
            );

        } else if (logoWasPublished || logoWasUnpublished || previewWasPublished || previewWasUnpublished) {
          $('#story-header__flash').html(
            '<strong><i class="fa fa-fw fa-check></i></strong>&nbsp;' +
            '<p>' + (logoWasPublished || logoWasUnpublished || previewWasPublished || previewWasUnpublished) + ' successfully</p>'
          );
        }

        if (flashIsPresent) {
          setTimeout(function () {
            $flash.removeClass('alert alert-success alert-info alert-warning alert-danger')
          }, 2500);
        }
      };

  console.log('resData', resData);

  updateStory();
  toggleFormDone($('#story-settings-form'), true)
  flash();

  /**
   *  update the hidden ad inputs
   */
  $hiddenAdInputs.find('input').prop('disabled', true);
  if (resData.newAds) {
    $hiddenAdInputs
      .find('[name*="topic"][name*="[id]"]').val(resData.newAds.topic.id).end()
      .find('[name*="retarget"][name*="[id]"]').val(resData.newAds.retarget.id);

  } else if (resData.adsWereDestroyed) {
    $hiddenAdInputs
      .find('[name*="[id]"]').val('').end()
      .find('[name*="[_destroy]"]').prop('checked', false);
  }

}());