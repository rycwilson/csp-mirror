
(function () {

  var storyParams = <%= raw @story_params.to_json %>
      story = <%= raw @story.to_json({
                    only: [:id, :title, :logo_published, :preview_published, :published],
                    methods: [:previous_changes, :csp_story_path],
                    include: {
                      success: {
                        only: [],
                        include: {
                          customer: { only: [:name] }
                        }
                      }
                    }
                  }) %>,
      $hiddenAdInputs = $('#story-settings__ads-inputs'),
      createAds = function () {
        return (story.published && story.previous_changes.published) ? true : false;
      },
      removeAds = function () {
        return (!story.published && story.previous_changes.published) ? true : false;
      },
      // update any story attributes that fall under Settings
      updateStory = function () {
        var storyIndex = CSP.stories.findIndex(function (st) { return st.id === story.id });
        CSP.stories[storyIndex].csp_story_path = story.csp_story_path;
        CSP.stories[storyIndex].logo_published = story.logo_published;
        CSP.stories[storyIndex].preview_published = story.preview_published;
        CSP.stories[storyIndex].published = story.published;
        CSP.stories[storyIndex].title = story.title;
        $('#story-edit-header > div.story-title > span:nth-of-type(2)').text(story.title);
      };

  console.log('storyParams', storyParams)

  updateStory();
  toggleFormDone($('#story-settings-form'), true)

  $hiddenAdInputs.find('input').prop('disabled', true);

  if (storyParams.newAds) {
    $hiddenAdInputs
      .find('[name*="topic"][name*="[id]"]').val(storyParams.newAds.topic.id).end()
      .find('[name*="retarget"][name*="[id]"]').val(storyParams.newAds.retarget.id);

  } else if (storyParams.adsWereRemoved) {
    $hiddenAdInputs
      .find('[name*="[id]"]').val('').end()
      .find('[name*="[_destroy]"]').prop('checked', false);
  }


}());