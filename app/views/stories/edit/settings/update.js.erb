
(function () {

  var resData = <%= raw @response_data.to_json %>,
      story = <%= raw @story.to_json({
                    only: [:id, :title, :logo_published, :preview_published, :published],
                    methods: [:previous_changes, :csp_story_path],
                    include: {
                      success: {
                        only: [],
                        include: {
                          customer: { only: [:name] }
                        }
                      }
                    }
                  }) %>,
      $hiddenAdInputs = $('#story-settings__ads-inputs'),

      // update any story attributes that fall under Settings
      updateStory = function () {
        var storyIndex = CSP.stories.findIndex(function (st) { return st.id === story.id });
        CSP.stories[storyIndex].csp_story_path = story.csp_story_path;
        CSP.stories[storyIndex].logo_published = story.logo_published;
        CSP.stories[storyIndex].preview_published = story.preview_published;
        CSP.stories[storyIndex].published = story.published;
        CSP.stories[storyIndex].title = story.title;
        $('#story-edit-header > div.story-title > span:nth-of-type(2)').text(story.title);
      };

  console.log('resData', resData);

  updateStory();
  toggleFormDone($('#story-settings-form'), true)

  if (resData.storyErrors) {
    flashDisplay("Failed to update Story:\xa0\xa0" + resData.storyErrors.join(', '), 'danger');
  } else if (resData.gadsErrors) {
    flashDisplay("Failed to create Promoted Story:\xa0\xa0" + resData.gadsErrors.join(', '), 'danger');
  } else if (resData.gadsWereCreated) {
    flashDisplay('Promoted Story was created successfully', 'success');
  } else if (resData.gadsWereRemoved) {
    flashDisplay('Promoted Story was removed successfully', 'success');
  }

  /**
   *  update the hidden ad inputs
   */
  $hiddenAdInputs.find('input').prop('disabled', true);
  if (resData.newAds) {
    $hiddenAdInputs
      .find('[name*="topic"][name*="[id]"]').val(resData.newAds.topic.id).end()
      .find('[name*="retarget"][name*="[id]"]').val(resData.newAds.retarget.id);

  } else if (resData.adsWereDestroyed) {
    $hiddenAdInputs
      .find('[name*="[id]"]').val('').end()
      .find('[name*="[_destroy]"]').prop('checked', false);
  }

}());