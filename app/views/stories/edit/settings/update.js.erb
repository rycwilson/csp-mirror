
(function () {

  var story = <%= raw @story.to_json({
                    only: [:id, :title, :logo_published, :preview_published, :published],
                    methods: [:previous_changes, :csp_story_path]
                  }) %>,
      createAds = function () {
        return (story.published && story.previous_changes.published) ? true : false;
      },
      removeAds = function () {
        return (!story.published && story.previous_changes.published) ? true : false;
      },
      // update any story attributes that fall under Settings
      updateStory = function () {
        var storyIndex = app.stories.findIndex(function (st) { return st.id === story.id });
        app.stories[storyIndex].csp_story_path = story.csp_story_path;
        app.stories[storyIndex].logo_published = story.logo_published;
        app.stories[storyIndex].preview_published = story.preview_published;
        app.stories[storyIndex].published = story.published;
        app.stories[storyIndex].title = story.title;
        $('a.story-title').text(story.title);
      };

  updateStory();

  // create the ad
  if ( createAds() ) {
    $.post({
      url: '/stories/' + story.id + '/promote',
      success: function (data, status, xhr) {
        $.post({
          url: '/stories/' + story.id + '/adwords',
          dataType: 'script'
        });
      }
    });

  // remove ad if story unpublished;
  // remove the adwords ad first, as ad.ad_id will be necessary to make the api call
  } else if ( removeAds() ) {
    $.ajax({
      url: '/stories/' + story.id + '/adwords',
      method: 'delete',
      dataType: 'json',
      success: function (data, status, xhr) {
        $.ajax({
          url: '/stories/' + story.id + '/promote',
          method: 'delete',
          dataType: 'script',
          success: function () {
            // corresponds to flash timeout
            setTimeout(function () {
              $('input.bs-switch').bootstrapSwitch('disabled', false);
            }, 3000);
          }
        });
      }
    });

  } else {

    $('#story-settings-form button[type="submit"]').find('.fa-spinner, .fa-check').toggle()
    window.setTimeout(function () {
      $('#story-settings-form button[type="submit"]').find('.fa-check, span').toggle();
    }, 2000);

  }

}());