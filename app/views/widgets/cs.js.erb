(function (window, document) {

  "use strict";

  var jQuery, $; // localize jquery variables

  if (window.jQuery === undefined || isOldVersion(window.jQuery.fn.jquery)) {
    loadScript("https://ajax.googleapis.com/ajax/libs/jquery/1.12.3/jquery.min.js",
      function () {
        /* Restore $ and window.jQuery to their previous values and store the
           new jQuery in our local jQuery variables. */
        $ = jQuery = window.jQuery.noConflict(true);
        main();
      });
  } else {
    $ = jQuery = window.jQuery;
    main();
  }

  function main () {

    $(function () {

      var category = $('#cs-script').data('category'),
          product = $('#cs-script').data('product'),
          $widgetStylesheet = $("<link>", {
            rel: "stylesheet",
            type: "text/css",
            href: "<%= URI.join(root_url, asset_path('cs-widget.css')).to_s %>"
          });

          // get font awesome if it doesn't exist on host
          if ($('link[href*="font-awesome"]').length === 0) {
            $("<link>", {
              rel: "stylesheet",
              type: "text/css",
              href: "https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
            }).appendTo('head');
          }

      // wait for stylesheet to load ...
      $widgetStylesheet.appendTo('head').on('load', function () {

        $.ajax({
          url: "<%= URI.join(root_url, widget_data_path) %>",
          dataType: 'jsonp',
          data: { category: category,
                  product: product },
          success: function (data) {
            $('#cs-container').html(data.html);
            // wait for all images to load so dimension calculations are correct ...
            var $images = $('#cs-container img'), loadedImages = 0;
            $images.on('load', function (e) {
              if (++loadedImages === $images.length) {
                buildWidget();
              }
            })
          }
        }); // ajax

      });
    });
  }

  function buildWidget () {
    slideDrawerPlugin();
    xScrollBoundaries()
    scrollHandlers();
    centerLogos();
    // if user is using a mouse, this will hose dimensions
    // (in a somewhat random way)
    // compensate for this ...
    if ($('.cs-drawer-content').css('height') !== '141px') {
      $('.cs-drawer-content').css('height', '141px');
      $('.cs-drawer-items').css('height', '141px');
    }
    if (<%= @company.widget.show %>) {
      setTimeout(function () {
        $('#cs-container header').click();
        if (<%= @company.widget.timeout %>) {
          setTimeout(function () {
            $('#cs-container header').click();
          }, <%= @company.widget.timeout_count %>);
        }
      }, <%= @company.widget.delay %>);
    }
    // adjust width for different font families
    $('#cs-container').find('header').css(
        'width',
        (parseInt($('#cs-container header > span').css('width'), 10) + 30).toString() + "px"
      );
    $('#cs-container')
      .slideDrawer()
      .css({ opacity: 0, visibility: "visible" })
      .animate({ opacity: 1 }, 200);
    trackVisitor();
  }

  // slideout drawer plugin
  function loadScript (url, callback) {
    var scriptTag = document.createElement('script');
    scriptTag.setAttribute("type", "text/javascript");
    scriptTag.setAttribute("src", url);
    if (typeof callback !== "undefined") {
      if (scriptTag.readyState) {
        /* For old versions of IE */
        scriptTag.onreadystatechange = function () {
          if (this.readyState === 'complete' || this.readyState === 'loaded') {
            callback();
          }
        };
      } else {
        scriptTag.onload = callback;
      }
    }
    (document.getElementsByTagName("head")[0] || document.documentElement).appendChild(scriptTag);
  }

  // bootstrap requires >= v1.9 of jquery
  function isOldVersion (jqVer) {
    var majorRel = jqVer.split('.')[0],
        minorRel = jqVer.split('.')[1];
    if (majorRel === '1' && parseInt(minorRel, 10) < 9) {
      return true;
    }
    else return false;
  }

  function slideDrawerPlugin () {

    var drawer = {

      init: function (options, div) {

        if (options.showDrawer === true && options.slideTimeout === true) {
          setTimeout(function() {
            drawer.slide(div, options.drawerHiddenHeight, options.slideSpeed);
          }, options.slideTimeoutCount);
        } else if (options.showDrawer === 'slide') {
          // Set drawer hidden with slide effect
          drawer.slide(div, options.drawerHiddenHeight, options.slideSpeed);
        } else if (options.showDrawer === false) {
          // Set drawer to hide
          drawer.hide(options, div);
        }

        $('#cs-container header').on('click', function () {
          drawer.toggle(options, div);
        });
      },

      //Toggle function
      toggle: function (options, div) {
        ($(div).height() + options.borderHeight === options.drawerHeight) ?
          drawer.slide( div, options.drawerHiddenHeight, options.slideSpeed ) :
          drawer.slide( div, options.drawerHeight-options.borderHeight, options.slideSpeed );
      },

      // Slide animation function
      slide: function (div, height, speed) {
        $(div).animate({ 'height': height }, speed, 'swing', function () {
          $('#cs-container header i[class*="fa-chevron"]').toggle();
        });
      },

      hide: function (options, div) {
        $(div).css('height', options.drawerHiddenHeight);
      },

    };
    // Function wrapper
    $.fn.slideDrawer = function (options) {

      var $drawerContent = $('#cs-container .cs-drawer-content'),  /* Content height of drawer */
          borderHeight = parseInt($drawerContent.css('border-top-width')); /* Border height of content */

      var drawerHeight = this.height() + borderHeight; /* Total drawer height + border height */
      var drawerContentHeight = $drawerContent.outerHeight() //- borderHeight; /* Total drawer content height minus border top */
      var drawerHiddenHeight = (drawerHeight - drawerContentHeight) - borderHeight; /* How much to hide the drawer, total height minus content height */
      var defaults = {
        showDrawer: 'slide', /* Drawer hidden on load by default, options (true, false, slide) */
        slideSpeed: 700, /* Slide drawer speed 3 secs by default */
        slideTimeout: true, /* Sets time out if set to true showDrawer false will be ignored */
        slideTimeoutCount: 5000, /* How long to wait before sliding drawer */
        drawerContentHeight: drawerContentHeight, /* Div content height no including tab or border */
        drawerHeight: drawerHeight, /* Full div height */
        drawerHiddenHeight: drawerHiddenHeight, /* Height of div when hidden full height minus content height */
        borderHeight: borderHeight /* border height if set in css you cann overwrite but best just leave alone */
      };

      /* Overwrite defaults */
      var pluginOptions = $.extend(defaults, options);

      return this.each(function () {
        drawer.init(pluginOptions, this);
      });
    };

  }

  function centerLogos () {
    $('#cs-container img').each(function (image) {
      var height = $(this).outerHeight(),
          maxHeight = parseInt($(this).css('max-height')),
          diff = maxHeight - height;
      if (diff) {
        $(this).css('margin-top', diff / 2);
        $(this).css('margin-bottom', diff / 2);
      }
    });
  }

  /*
    when scrolling past boundaries with trackpad, prevent default browser behavior
    (back/forward navigation)
  */
  function xScrollBoundaries () {
    var maxX = null;
    $(document).on('wheel', '.row-horizon', function (event) {
      maxX = $(this).prop('scrollWidth') - $(this).prop('offsetWidth');
      // If this event looks like it will scroll beyond the bounds of the element,
      //  prevent it and set the scroll to the boundary manually
      if ($(this).prop('scrollLeft') + event.originalEvent.deltaX < 0 ||
          $(this).prop('scrollLeft') + event.originalEvent.deltaX > maxX) {
        event.preventDefault();
        $(this).prop('scrollLeft', Math.max(0, Math.min(maxX, $(this).prop('scrollLeft') + event.originalEvent.deltaX)));
      }
    });
  }

  function scrollHandlers () {

    var $carousel = $('.row-horizon'),
        $paginationContainer = $('.cs-pagination-row'),
        scrollWidth = $carousel.prop('scrollWidth'),
        maxScrollPosition = scrollWidth - $carousel.width(),
        numPages = Math.ceil(scrollWidth / $carousel.width()),
        pageWidth = Math.ceil(scrollWidth / numPages),
        currentPage = 1,
        scrollPosition = null, scrollRemaining = null,
        dynamicPage = null, lastPage = null,
        calculateDynamicPage = function (position, numPages, pageWidth, carouselWidth) {
          for (var i = 1; i <= numPages; i++) {
            if (position + (carouselWidth / 2) < pageWidth * i) { return i; }
          }
        },
        paginationTrackScroll = function () {
          dynamicPage =
            calculateDynamicPage($(this).scrollLeft(), numPages, pageWidth, $(this).width());
          if (dynamicPage !== currentPage) {
            lastPage = currentPage;
            currentPage = dynamicPage;
            $paginationContainer.find('div:nth-of-type(' + lastPage.toString() + ')')
                                .removeClass('cs-current-page-dot');
            $paginationContainer.find('div:nth-of-type(' + currentPage.toString() + ')')
                                .addClass('cs-current-page-dot');
          }
        },
        paginationScroll = function ($carousel, pageWidth, paginationTrackScroll) {
          // $(this) refers to the div.page-dot clicked
          return function (e) {
            var goToPage = null, scrollTo = null;

            if ($(this).hasClass('cs-current-page-dot')) { e.preventDefault(); }

            // turn off other handlers until animation is complete
            $carousel.off('scroll', paginationTrackScroll);
            // .. but not the currently executing handler ... things get weird
            // $('.cs-page-dot').off('click', paginationScroll)

            $(this).addClass('goto-page-dot');
            $('.cs-current-page-dot').removeClass('cs-current-page-dot');
            $('.cs-page-dot').each(function (index, pageDot) {
              if ($(this).hasClass('goto-page-dot')) {
                scrollTo = index * pageWidth;
                $(this).addClass('cs-current-page-dot')
                       .removeClass('goto-page-dot');
                return false;
              }
            });
            $carousel.animate({ scrollLeft: scrollTo }, 1000, function () {
              $carousel.on('scroll', paginationTrackScroll);
            });
          };
        },
        arrowScrollLeft = function ($carousel, pageWidth) {
          return function (e) {
            var scrollPosition = $carousel.scrollLeft();
            $('.cs-page-dot').off('click', paginationScroll);
            if (scrollPosition >= pageWidth) {
              $carousel.animate({ scrollLeft: '-=' + pageWidth.toString() }, 1000,
                function () { $('.cs-page-dot').on('click', paginationScroll); });
            }
            else {
              $carousel.animate({ scrollLeft: '-=' + scrollPosition.toString() }, 1000,
                function () { $('.cs-page-dot').on('click', paginationScroll); });
            }
          };
        },
        arrowScrollRight = function ($carousel, pageWidth, scrollWidth) {
          return function (e) {
            var scrollPosition = $carousel.scrollLeft(),
                scrollRemaining = scrollWidth - (scrollPosition + $carousel.width());
            $('.cs-page-dot').off('click', paginationScroll);
            if (scrollRemaining >= pageWidth) {
              $carousel.animate({ scrollLeft: '+=' + pageWidth.toString() }, 1000,
                function () { $('.cs-page-dot').on('click', paginationScroll); });
            } else {
              $carousel.animate({ scrollLeft: '+=' + scrollRemaining.toString() }, 1000,
                function () { $('.cs-page-dot').on('click', paginationScroll); });
            }
          };
        };

    // set up pagination
    for (var i = 0; i < numPages; i++) {
      if (i === 0) {
        $paginationContainer
          .append("<div class='cs-page-dot cs-current-page-dot'></div>");
      } else {
        $paginationContainer
          .append("<div class='cs-page-dot'></div>");
      }
    }

    $carousel.on('scroll', paginationTrackScroll);

    $('.cs-scroll-left')
      .on('click', arrowScrollLeft($carousel, pageWidth));

    $('.cs-scroll-right')
      .on('click', arrowScrollRight($carousel, pageWidth, scrollWidth));

    $('.cs-page-dot')
      .on('click', paginationScroll($carousel, pageWidth, paginationTrackScroll));
  }

  function trackVisitor (companySubdomain) {

    var companySubdomain = '<%= @company.subdomain %>'

    $('#cs-container').append(
      '<iframe class="cs-iframe" height="0" width="0" style="display:none" ' +
      'src="https://' + companySubdomain + '.customerstories.net/track_widget"></iframe>');

    // var trackingDoc = $('#cs-container').find('iframe')[0].contentWindow.document,
    //     trackingHost = (("https:" == document.location.protocol) ? "https://s.adroll.com" : "http://a.adroll.com"),
    //     trackingUrl = trackingHost + '/j/roundtrip.js';

    // trackingDoc.open();
    // trackingDoc.write("<html><head><script>adroll_adv_id='" + advId + "';adroll_pix_id='" + pixId + "';</script><script src='" + trackingUrl + "'></script><script>setTimeout(function(){try{__adroll.record_user({'adroll_segments':'" + segmentId + "'})}catch(err){};},1000);</script></head></html>");
    // trackingDoc.close();
  }

}(window, document));