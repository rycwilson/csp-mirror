
(function () {
  var contribution = <%= raw @contribution.to_json({ only: [:id, :publish_contributor] }) %>,
      contributor = <%= raw @contribution.contributor.to_json({
                      only: [:id, :first_name, :last_name, :email, :title, :phone, :linkedin_url],
                      methods: [:full_name, :previous_changes]
                    }) %>,
      $trContribution = $('tr.shown[data-contribution-id="' + contribution.id + '"]'),
      $trContributor = $trContribution.next(),
      rowData = $trContribution.closest('table').DataTable().row($trContribution).data();

  // linkedin profile
  // .. removed
  if (contributor.previous_changes.linkedin_url && !contributor.linkedin_url) {
    $trContributor.find('.csp-widget-container').empty();
    $trContributor.find('.placeholder-widget-container').empty();
    $trContributor.find('.linkedin-widget-container').empty().addClass('hidden');
    $trContributor.find('.linkedin-profile').addClass('hidden');

  // ... added
  } else if (contributor.previous_changes.linkedin_url) {
    // loadCspOrPlaceholderWidget($trContributor, contributor);
    loadLinkedinWidget($trContributor, contributor);
    $trContributor.find('.linkedin-profile').removeClass('hidden');
  }

  delete contributor.previous_changes;

  // update datatables
  // don't update until the child row is closed, or the re-draw will hose things
  // timeout is necessary because this appears to step on the normal open/close behavior (contributor_details.js)
  $trContribution.one('click', 'td.contributor-details', function (e) {
    setTimeout(function () {
      $('#prospect-contributors-table, #curate-contributors-table').DataTable()
        .row('[data-contribution-id="' + contribution.id + '"]')  // don't use $trContribution here as it won't apply to curate table
        .data(
          Object.assign(
            rowData,
            { contributor: contributor },
            { publish_contributor: contribution.publish_contributor }
          )
        );
    }, 100)

  })

  toggleFormDone($('#contribution-form-' + contribution.id), true);

}());