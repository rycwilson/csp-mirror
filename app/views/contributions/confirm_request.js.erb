(function () {

  var requestEmail = <%= raw @request_email.to_json %>,
      contribution = <%= raw @contribution.to_json(include: { contributor: {}, referrer: {}, success: { include: :customer } }) %>,
      contributor = contribution.contributor,
      flashStatus = "<%= @flash_status %>",
      flashMesg = "<%= @flash_mesg %>",
      $modal = $('#email-confirmation-modal'),
      // things go haywire if a different selector is used,
      // e.g. $('textarea')
      $summernote = $modal.find("[data-provider='summernote']");

  /*
    Upon initilization, summernote will focus on the textarea by default.
    The focus:false setting does not appear to prevent this.
    So, when the modal opens a one-time event listener is set to handle
    blurring the textarea immediately upon focus
  */
  $modal.on('shown.bs.modal', function () {
    $summernote.one('summernote.focus', function() {
      $modal.find('.note-editable').trigger('blur');
    });
    loadSummernote();
  })

  if (flashStatus == 'danger') {  // curator info missing
    flashDisplay(flashMesg, flashStatus)
  } else {
    $("[data-toggle='tooltip']").tooltip('destroy');
    loadModalValues();
    $modal.modal('show');
  }

  function loadModalValues () {
    $modal.find('#contribution_id').val(contribution.id)
    $modal.find('#request-recipient').html(
       'Recipient:&nbsp;&nbsp;' + contributor.first_name + ' '
                                + contributor.last_name + '&nbsp;&nbsp;'
                                + '&lt' + contributor.email + '&gt');
    $modal.find("#contribution_request_subject").val(requestEmail.subject);
  }

  /*
    this code must be run AFTER the modal opens
  */
  function loadSummernote () {
    // $modal.find('.note-codable').hide() // see comment below
    $summernote.summernote('code', requestEmail.body);
  }

}());


