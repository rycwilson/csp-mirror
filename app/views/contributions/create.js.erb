
(function () {

  // this is a subset of contribution source data; don't need all of it since tables are being ajax.reloaded
  var company = <%= raw @company.to_json({
        only: [],
        include: {
          customers: { only: [:id, :name] },
          contributors: { only: [:id], methods: [:full_name] },
          referrers: { only: [:id], methods: [:full_name] }
        }
      }) %>,
      contribution = <%= raw @contribution.to_json({
        only: [:id], methods: [:timestamp],
        include: {
          # success source data needed to update successes table (with addition of previous_changes method)
          success: {
            only: [:id, :name, :description],
            methods: [:display_status, :referrer, :contact, :previous_changes, :timestamp],
            include: {
              curator: { only: [:id], methods: [:full_name] },
              customer: { only: [:id, :name, :slug] },
              story: { only: [:id, :title, :slug] }
            }
          }
        }
      }) %>,
      isCurateView = function () {
        return $('a[href="#curate-contributors"]').parent().hasClass('active')
      },
      openContributorDetails = function ($tr) {
        $tr.find('.contributor-details').trigger('click');
      },
      updateSuccess = function (success) {
        if (success.previous_changes.id) {
          $('#successes-table').DataTable().row.add(success).draw();
        } else {
          $('#successes-table').DataTable()
            .row('[data-success-id="' + success.id + '"]')
            .data(success)
            .draw();
        }
      };

  updateSuccess(contribution.success);

  // reload tables and scroll to new contributor
  // (reload tables with separate .reload calls to ensure actions only happen once)
  $('#prospect-contributors-table').DataTable().ajax.reload(function (contributions) {
      // var rowsAreGrouped = $('#toggle-group-by-success').prop('checked'), groupIndex;
      if (!isCurateView()) {
        updateSelectOptions(company, $('#successes-table').DataTable().rows().data().toArray());
        $('html, body').animate({ scrollTop: 65 }, 200)
          .promise()
          .then(function () {
            $('.contributors.curator-select').val(contribution.success.curator.id).trigger('<change></change>')
            $('#contributors-filter').val('success-' + contribution.success.id).trigger('change');
            openContributorDetails(
              $('#prospect-contributors-table tr[data-contribution-id="' + contribution.id + '"]')
            );
            $('#contributors-filter').select2('focus');
            $(document).one('click', function () {
              $('#contributors-filter').next().removeClass('select2-container--focus');
            })
            toggleFormDone($('#new-contributor-form'));
            $('#new-contributor-modal').modal('hide');
          });
        }
    });

  $('#curate-contributors-table').DataTable().ajax.reload(function (contributions) {
      if (isCurateView()) {
        $('html, body').animate({ scrollTop: 65 }, 200)
          .promise()
          .then(function () {
            openContributorDetails(
              $('#prospect-contributors-table tr[data-contribution-id="' + contribution.id + '"]')
            );
            toggleFormDone($('#new-contributor-form'));
            $('#new-contributor-modal').modal('hide');
          });
      }
    })

}());








