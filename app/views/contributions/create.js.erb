
(function () {

  // this is a subset of contribution source data; don't need all of it since tables are being ajax.reloaded
  var company = <%= raw @company.to_json({
        only: [],
        include: {
          customers: { only: [:id, :name] },
          contributors: { only: [:id], methods: [:full_name] },
          referrers: { only: [:id], methods: [:full_name] }
        }
      }) %>,
      contribution = <%= raw @contribution.to_json({
        only: [:id], methods: [:timestamp],
        include: {
          # success source data needed to update successes table (with addition of previous_changes method)
          success: {
            only: [:id, :name, :win_story],
            methods: [:display_status, :referrer, :contact, :previous_changes, :timestamp],
            include: {
              curator: { only: [:id], methods: [:full_name] },
              customer: { only: [:id, :name, :slug] },
              story: { only: [:id, :title, :slug] }
            }
          }
        }
      }) %>,
      $modal = $('#new-contributor-modal'),
      isCurateView = $('a[href="#story-contributors"]').parent().hasClass('active'),
      openContributorForm = function ($tr) {
        $tr.find('td.toggle-child-row').trigger('click');
        // scroll to center (but only for the current table view)
        if ($tr.closest('table').is('#contributors-table') && !isCurateView ||
            $tr.closest('table').is('#curate-contributors-table') && isCurateView) {
          window.scrollTo(0, $tr.offset().top - (window.innerHeight / 2) + (($tr.next().outerHeight() + $tr.outerHeight()) / 2));
        }
      },
      updateSuccess = function (success) {
        if (success.previous_changes.id) {
          $('#successes-table').DataTable().row.add(success).draw();
        } else {
          $('#successes-table').DataTable()
            .row('[data-success-id="' + success.id + '"]')
            .data(success)
            .draw();
        }
      };

  updateSuccess(contribution.success);

  // reload tables and scroll to new contributor
  // (reload tables with separate .reload calls to ensure actions only happen once)
  $('#contributors-table').DataTable().ajax.reload(function (contributions) {
      // var rowsAreGrouped = $('#toggle-group-by-success').prop('checked'), groupIndex;
      if (!isCurateView) {
        updateSelectOptions(company, $('#successes-table').DataTable().rows().data().toArray());
        $('.contributors.curator-select').val(contribution.success.curator.id).trigger('change')
        $('#contributors-filter').val('success-' + contribution.success.id).trigger('change');
        $('#contributors-filter').select2('focus');
        toggleFormDone($('#new-contributor-form'));
        $modal
          .one('hidden.bs.modal', function () {
            openContributorForm(
              $('#contributors-table tr[data-contribution-id="' + contribution.id + '"]')
            );
          })
          .modal('hide');
      }
    });

  $('#curate-contributors-table').DataTable().ajax.reload(function (contributions) {
      if (isCurateView) {
        toggleFormDone($('#new-contributor-form'));
        $modal
          .one('hidden.bs.modal', function () {
            openContributorForm(
              $('#curate-contributors-table tr[data-contribution-id="' + contribution.id + '"]')
            );
          })
          .modal('hide');
      }
    })

}());








