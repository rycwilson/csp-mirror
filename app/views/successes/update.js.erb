
(() => {

  const success = <%= raw @success.to_json({ only: [:id, :win_story_completed], methods: [:previous_changes, :display_status] }) %>;
  const $tr = $(`#successes-table tr[data-success-id="${ success.id }"]`);
  const $form = $('.success-form');
  const $submitBtn = $form.find('button[type="submit"]');
  const isEditMode = $('#win-story-editor').attr('contenteditable') === 'true';

  $submitBtn.find('i.fa-spin, i.fa-check').toggle();

  setTimeout(() => {
    // re-enable items disabled during form submission
    $('#successes-table td.toggle-child-row').removeClass('disabled');
    $('button.win-story-actions__edit').prop('disabled', false);

    $form.attr('data-submitted', '');
    if (isEditMode) {
      $submitBtn.prop('disabled', true)
                  .end()
                .find('.fa-check, .save-changes')
                  .toggle();
    } else {
      $submitBtn.toggleClass('save-changes mark-completed')
                .find('.fa-check, .mark-completed')
                  .toggle();
      if (success.win_story_completed) $submitBtn.hide();
    }

    // update status if win story was marked completed
    if (success.previous_changes.win_story_completed) {
      $tr.find('td.status').html(success.display_status)
    }
  }, 2000);

  // update datatables => not necessary as we're not keeping Success.win_story in datatables

})();
