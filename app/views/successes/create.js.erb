
(function () {

  var company = <%= raw @company.to_json({
                      only: [],
                      include: {
                        curators: { only: [:id], methods: [:full_name] },
                        customers: { only: [:id, :name] },
                        contributors: { only: [:id], methods: [:full_name] },
                        referrers: { only: [:id], methods: [:full_name] },
                        invitation_templates: { only: [:id, :name] }
                      }
                    }) %>,
      newSuccess = <%= raw @success.to_json({
                          only: [:id],
                          include: { curator: { only: [:id] } }
                        }) %>,
      openSuccessForm = function () {
        // this assumes the filter has been applied and this is the only tr in the table
        $('#successes-table td.success-details').trigger('click');
      },
      cbDone = function (success) {
        return function () {
          var ignoreClick = function (e) { e.stopPropagation(); };
          $('.successes.curator-select').val(success.curator.id).trigger('change')
          $('#successes-filter').val('success-' + success.id).trigger('change');

          $('#successes-filter').select2('focus');
          // don't let modal reset actions trigger the unfocus
          $(document).on('click', '#new-success-modal *', ignoreClick);
          $(document).one('click', function (e) {
            $('#successes-filter').next().removeClass('select2-container--focus');
            $(document).off('click', ignoreClick)
          })
          $('#new-success-modal')
            .one('hidden.bs.modal', openSuccessForm)
            .modal('hide')
        }
      };

  // update the app object
  CSP.company.customers = company.customers
  CSP.company.invitation_templates = company.invitation_templates

  /**
   * the datatable filter state persists through a reload,
   */
  $('#successes-table').DataTable().ajax.reload(function (successes) {
    $('#prospect-contributors-table').DataTable().ajax.reload(function (contributions) {
      updateSelectOptions(company, successes);
      toggleFormDone($('#new-success-form'), false, cbDone(newSuccess));
    });
  });

}());