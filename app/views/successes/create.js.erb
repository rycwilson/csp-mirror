
(() => {
  const newCustomerWin = <%= raw @success.to_json({
    only: [:id],
    include: { curator: { only: [:id] } }
  }) %>;
  const openChildRow = (cwId) => {
    $('#successes-table')
      .find(`tr[data-success-id="${ cwId }"] > td.toggle-child-row`) 
        .trigger('click');
  };
  const $submitBtn = $('button[type="submit"][form="new-success-form"]');
  const reloadCustomerWins = $.Deferred();
  const reloadContributors = $.Deferred();
  let customerWins, contributors;

  $.when(reloadCustomerWins, reloadContributors)
    .done(() => {
      // APP.updateSelectOptions(company, successes);
      $('.successes.curator-select')
        .val(newCustomerWin.curator.id)
        .trigger('change');
      $('#successes-filter')
        .val(`success-${ newCustomerWin.id }`)
        .trigger('change');
      openChildRow(newCustomerWin.id);
      $form.attr('data-submitted', '');
      $submitBtn.find('.fa-check, span').toggle();
      $('#new-success-modal').modal('hide');
    })

  // NOTE: the datatable filter state persists through a reload,
  $('#successes-table').DataTable().ajax.reload(data => {
    customerWins = data;
    reloadCustomerWins.resolve();
  });
  $('#contributors-table').DataTable().ajax.reload(data => {
    contributors = data
    reloadContributors.resolve();
  });

})();