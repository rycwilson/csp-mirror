
(function () {

  var company = <%= raw @company.to_json({
                      only: [],
                      include: {
                        curators: { only: [:id], methods: [:full_name] },
                        customers: { only: [:id, :name] },
                        contributors: { only: [:id], methods: [:full_name] },
                        referrers: { only: [:id], methods: [:full_name] },
                        crowdsourcing_templates: { only: [:id, :name] }
                      }
                    }) %>,
      newSuccess = <%= raw @success.to_json({
                          only: [:id],
                          include: { curator: { only: [:id] } }
                        }) %>,
      cbDone = function (success) {
        return function () {
          // ref: https://stackoverflow.com/questions/6677035
          $('html, body')
            .animate({ scrollTop: 65 }, 200)
            .promise()
            .then(function () {
              var ignoreClick = function (e) { e.stopPropagation(); }
              $('.successes.curator-select').val(success.curator.id).trigger('change')
              $('#successes-filter').val('success-' + success.id).trigger('change');
              $('#successes-table td.success-details').trigger('click');
              $('#successes-filter').select2('focus');
              // don't let modal reset actions trigger the unfocus
              $(document).on('click', '#new-success-modal *', ignoreClick);
              $(document).one('click', function (e) {
                $('#successes-filter').next().removeClass('select2-container--focus');
                $(document).off('click', ignoreClick)
              })
              $('#new-success-modal').modal('hide')
            });
        }
      };

  // update the app object
  app.company.customers = company.customers
  app.company.crowdsourcing_templates = company.crowdsourcing_templates

  /**
   * the datatable filter state persists through a reload,
   */
  $('#successes-table').DataTable().ajax.reload(function (successes) {
    $('#prospect-contributors-table').DataTable().ajax.reload(function (contributions) {
      updateSelectOptions(company, successes);
      toggleFormDone($('#new-success-form'), false, cbDone(newSuccess, false));
    });
  });

}());